---
title: "Arizona Treefrog Pop. Gen. Summary"
author: "C. E. Moore"
output:
  html_document:
    df_print: paged
---
Last updated on `r Sys.Date()`  
  
**Purpose:** Pop gen summary of HMCH populations of the AZ treefrog  
**Loaded packages:** `r (.packages())`  
  
*Note: Microsat data previously formatted from geneious output using 01a_DataPrep.R*

```{r paths and data load, echo=FALSE, message=FALSE, }
# packages
library(adegenet); library(ape); library(pegas); library(ggplot2); library(knitr); library(tidyverse)

# home
PATH <- "/home/chloe9mo/Documents/Projects/temporal_aztreefrog"

# in
## aztf
aztf <- read.csv(paste0(PATH, "/microsat_data/combined_aztf_loci_2021-12-23.csv"))

##example data
data("nancycats")

#to subset things!
# pop_aztf[, loc="Hwri23452"]
```

### **1. Missing Data Summary**
``` {r missing data, echo=FALSE, message=FALSE}
# loci missing
pct.loci.na <- lapply(X=aztf, FUN=function(x) round((length(which(x=='-1/-1'))/length(x)*100),3)) %>%
  bind_cols()

# indiv missing
pct.ind.na <- as.data.frame(apply(aztf[,c(3:19)], 1, function(x) { sum(x=='-1/-1')/length(x)*100 }))
pct.ind.na[c("ID","year")] <- aztf[,c(1,4)]
names(pct.ind.na) <- c("pct_na", "ID", "year")
pct.ind.na <- pct.ind.na[,c(2,3,1)]

kable(pct.ind.na %>% top_n(10), caption = "Percent missing data for top 10 individuals")
kable(pct.loci.na %>% select(!c(1:4)) %>% pivot_longer(cols = everything(), names_to = "loci", values_to = "pct_na"), caption = "Percent missing data for all loci")

## remove high missing individuals
aztf <- aztf %>%
  merge(., pct.ind.na) %>%
  filter(pct_na < 25) %>% #Mims et al removed ind with >25% missing data
  select(-pct_na)
```

``` {r make genind obj, echo=FALSE, message=FALSE}
ind_aztf_pop <- df2genind(aztf[,c(5:21)], sep = "/", ind.names = aztf$ID, NA.char = "-1/-1")
ind_aztf_pop@pop <- as.factor(aztf$pop) #assign populations

ind_aztf_yr <- df2genind(aztf[,c(5:21)], sep = "/", ind.names = aztf$ID, NA.char = "-1/-1")
ind_aztf_yr@pop <- as.factor(aztf$year)

o.2015 <- aztf %>% filter(year == '2015')
ind2015 <- df2genind(o.2015[,c(5:21)], sep = "/", ind.names = o.2015$ID, NA.char = "-1/-1")
ind2015@pop <- as.factor(o.2015$pop)

o.2019 <- aztf %>% filter(year == '2019') %>% group_by(pop) %>% filter(n() > 5)
ind2019 <- df2genind(o.2019[,c(5:21)], sep = "/", ind.names = o.2019$ID, NA.char = "-1/-1")
ind2019@pop <- as.factor(o.2019$pop)

#make pop data
pop_aztf_pop <- genind2genpop(ind_aztf_pop, quiet = TRUE) #global
pop_aztf_yr <- genind2genpop(ind_aztf_yr, quiet = TRUE)
pop2015 <- genind2genpop(ind2015, quiet = T)
pop2019 <- genind2genpop(ind2019, quiet = T)
```

### **2. Microsat Basic Info**
```{r ind data summary, echo=FALSE}
cat("Global Genind Objects Grouped by Populations")
summary(ind_aztf_pop)
cat("\n")
cat("Global Genind Objects Grouped by Year")
summary(ind_aztf_yr)
cat("\n")
cat("2015 Data Only")
summary(ind2015)
cat("\n")
cat("2019 Data Only")
summary(ind2019)
```
```{r pop data summary, echo=FALSE}
cat("Global Genpop Object Grouped by Populations")
summary(pop_aztf_pop)
cat("\n")
cat("Global Genpop Object Grouped by Year")
summary(pop_aztf_yr)
cat("\n")
cat("2015 Genpop Only")
summary(pop2015)
cat("\n")
cat("2019 Genpop Only")
summary(pop2019)
```
```{r obj summary plots, echo=FALSE}
summ_aztf_pop <- summary(ind_aztf_pop)
summ_aztf_yr <- summary(ind_aztf_yr)
summ_ind2015 <- summary(ind2015)
summ_ind2019 <- summary(ind2019)

par(mfrow=c(2,3))
plot(summ_aztf_pop$n.by.pop, summ_aztf_pop$pop.n.all, xlab="Colonies sample size",
ylab="Number of alleles",main="Alleles numbers and sample sizes",
type="n")
text(summ_aztf_pop$n.by.pop,summ_aztf_pop$pop.n.all,lab=names(summ_aztf_pop$n.by.pop))
barplot(summ_aztf_pop$loc.n.all, ylab="Number of alleles",
main="Number of alleles per locus")
barplot(summ_aztf_pop$Hexp-summ_aztf_pop$Hobs, main="Heterozygosity: expected-observed",
ylab="Hexp - Hobs")
barplot(summ_aztf_pop$n.by.pop, main="Sample sizes per population by pop",
ylab="Number of genotypes",las=3)
barplot(summ_aztf_yr$n.by.pop, main="Sample sizes per population by year",
ylab="Number of genotypes",las=3)

```
  
Is mean observed H significantly lower than mean expected H?
``` {r He v Ho ttest, echo=FALSE}
cat("Global - Pop")
t.test(summ_aztf_pop$Hexp, summ_aztf_pop$Hobs, pair=T, var.equal=TRUE, alter="greater")
cat("Global - Year")
t.test(summ_aztf_yr$Hexp, summ_aztf_yr$Hobs, pair=T, var.equal=TRUE, alter="greater")
cat("2015")
t.test(summ_ind2015$Hexp, summ_ind2015$Hobs, pair=T, var.equal=TRUE, alter="greater")
cat("2019")
t.test(summ_ind2019$Hexp, summ_ind2019$Hobs, pair=T, var.equal=TRUE, alter="greater")
cat("2019 vs 2015")
t.test(summ_ind2019$Hobs, summ_ind2015$Hobs, pair=T, var.equal=TRUE, alter="greater")
```
*Yes, it is!*  

### **3. Testing for HWE**
##### Years
``` {r HWE yr, echo=FALSE}
# global
globalHWE <- round(hw.test(ind_aztf_yr, B = 1000), digits = 3) #round() to make all values only 3 decimals
globalHWE.chi <- round(hw.test(ind_aztf_yr, B = 0), digits = 3)
cat("Global HWE -- MC Method")
kable(globalHWE)

#by population
## monte carlo
pop.hwt <- data.frame(sapply(seppop(ind_aztf_yr), 
                              function(ls) pegas::hw.test(ls, B=1000)[,4]))
pop.hwt <- t(data.matrix(pop.hwt))
## chi sq
pop.hwt.chi <- data.frame(sapply(seppop(ind_aztf_yr), 
                              function(ls) pegas::hw.test(ls, B=0)[,3]))
pop.hwt.chi <- t(data.matrix(pop.hwt.chi))

#summarize
alpha <- 0.05
Chisq.fdr <- matrix(p.adjust(pop.hwt.chi,method="fdr"), 
                    nrow=nrow(pop.hwt.chi))
MC.fdr <- matrix(p.adjust(pop.hwt, method="fdr"), 
                    nrow=nrow(pop.hwt))

Prop.pops.out.of.HWE <- data.frame(Chisq=apply(pop.hwt.chi<alpha, 1, mean), 
           MC=apply(pop.hwt<alpha, 1, mean),
           Chisq.fdr=apply(Chisq.fdr<alpha, 1, mean),
           MC.fdr=apply(MC.fdr<alpha, 1, mean))
cat("Proportion Loci per Population Out of HWE")
kable(Prop.pops.out.of.HWE)
```
##### Populations
``` {r HWE pop, echo=FALSE}
# global
globalHWE <- round(hw.test(ind_aztf_pop, B = 1000), digits = 3) #round() to make all values only 3 decimals
globalHWE.chi <- round(hw.test(ind_aztf_pop, B = 0), digits = 3)
cat("Global HWE -- MC Method")
kable(globalHWE)

#by population
## monte carlo
pop.hwt <- data.frame(sapply(seppop(ind_aztf_pop), 
                              function(ls) pegas::hw.test(ls, B=1000)[,4]))
pop.hwt <- t(data.matrix(pop.hwt))
## chi sq
pop.hwt.chi <- data.frame(sapply(seppop(ind_aztf_pop), 
                              function(ls) pegas::hw.test(ls, B=0)[,3]))
pop.hwt.chi <- t(data.matrix(pop.hwt.chi))

#summarize
alpha <- 0.05
Chisq.fdr <- matrix(p.adjust(pop.hwt.chi,method="fdr"), 
                    nrow=nrow(pop.hwt.chi))
MC.fdr <- matrix(p.adjust(pop.hwt, method="fdr"), 
                    nrow=nrow(pop.hwt))

## monte carlo
pop.hwt.yr <- data.frame(sapply(seppop(ind_aztf_yr), 
                              function(ls) pegas::hw.test(ls, B=1000)[,4]))
pop.hwt.yr <- t(data.matrix(pop.hwt.yr))
## chi sq
pop.hwt.yr.chi <- data.frame(sapply(seppop(ind_aztf_yr), 
                              function(ls) pegas::hw.test(ls, B=0)[,3]))
pop.hwt.yr.chi <- t(data.matrix(pop.hwt.yr.chi))

#summarize
alpha <- 0.05
Chisq.fdr.yr <- matrix(p.adjust(pop.hwt.yr.chi,method="fdr"), 
                    nrow=nrow(pop.hwt.yr.chi))
MC.fdr.yr <- matrix(p.adjust(pop.hwt.yr, method="fdr"), 
                    nrow=nrow(pop.hwt.yr))

Prop.pops.out.of.HWE <- data.frame(Chisq=apply(pop.hwt.chi<alpha, 1, mean), 
           MC=apply(pop.hwt<alpha, 1, mean),
           Chisq.fdr=apply(Chisq.fdr<alpha, 1, mean),
           MC.fdr=apply(MC.fdr<alpha, 1, mean))
cat("Proportion Loci per Population Out of HWE")
kable(Prop.pops.out.of.HWE)

Prop.pops.out.of.HWE.yr <- data.frame(Chisq=apply(pop.hwt.yr.chi<alpha, 1, mean), 
           MC=apply(pop.hwt.yr<alpha, 1, mean),
           Chisq.fdr=apply(Chisq.fdr.yr<alpha, 1, mean),
           MC.fdr=apply(MC.fdr.yr<alpha, 1, mean))
cat("Proportion Loci per Population Out of HWE")
kable(Prop.pops.out.of.HWE.yr)
```
### **Genetic Diversity**
#### Allelic Richness
``` {r allelic richness, echo=FALSE}
#for rarefied ->  finds lowest valid sample size across pops + loci and multiplies it by the ploidy (2)
ar.2015 <- allelicrichness(as.loci(ind2015), pop = as.loci(ind2015)$population, method = "rarefaction")
ar.2019 <- allelicrichness(as.loci(ind2019), pop = as.loci(ind2019)$population, method = "rarefaction")
# 
cat("2015")
apply(ar.2015, 1, mean)
cat("2019")
apply(ar.2019, 1, mean)
```

#### Observed & Expected Heterozygosity
##### 2015
``` {r 2015 hobs hexp, echo=FALSE}
# separate by population
Hobs <- t(sapply(seppop(ind2015), function(ls) summary(ls)$Hobs))
Hexp <- t(sapply(seppop(ind2015), function(ls) summary(ls)$Hexp))
h.exp.pop <- round(Hexp, 2)
h.obs.pop <- round(Hobs, 2)
cat("expected")
h.exp.pop
cat("observed")
h.obs.pop
cat("expected")
apply(h.exp.pop, 1, mean)
cat("observed")
apply(h.obs.pop, 1, mean)
cat("global observed")
mean(h.obs.pop)
#  observed frequently lower than expected, some pops inbreeding?
#  high amounts of diversity
```
0.6470588 0.6841176 0.6658824 0.6917647 0.6723529
0.6894118 0.7323529 0.6952941 0.5805882 0.6658824

##### 2019
``` {r 2019 hobs hexp, echo=FALSE}
# separate by population
Hobs <- t(sapply(seppop(ind2019), function(ls) summary(ls)$Hobs))
Hexp <- t(sapply(seppop(ind2019), function(ls) summary(ls)$Hexp))
h.exp.pop <- round(Hexp, 2)
h.obs.pop <- round(Hobs, 2)
cat("expected")
h.exp.pop
cat("observed")
h.obs.pop
cat("expected")
apply(h.exp.pop, 1, mean)
cat("observed")
apply(h.obs.pop, 1, mean)
cat("global observed")
mean(h.obs.pop)
#  observed frequently lower than expected, some pops inbreeding?
#  high amounts of diversity
```

### **4. Measuring and testing pop structure**
#### Global and locus fstat
``` {r f structure, echo=FALSE, message=FALSE}
library(hierfstat)
cat("Global F-statistics -- hierfstat")
cat("by population")
wc(ind_aztf_pop)
cat("by year")
wc(ind_aztf_yr)
cat("2015")
wc(ind2015)
cat("2019")
wc(ind2019)
```
##### Population grouping
``` {r structure loci pop, echo=FALSE}
ftab <- pegas::Fst(as.loci(ind_aztf_pop))
kable(round(ftab, 3), caption = "Per-locus F-statistics")

kable(colMeans(ftab), caption = "Global F-statistics -- pegas")
```

##### Year grouping
``` {r structure loci yr, echo=FALSE}
ftab.yr <- pegas::Fst(as.loci(ind_aztf_yr))
kable(round(ftab.yr, 3), caption = "Per-locus F-statistics")

kable(colMeans(ftab.yr), caption = "Global F-statistics -- pegas")
```

#### Confidence Interval on Fstat
##### Population Grouping
``` {r CI fstat pop, echo=FALSE}
at.pop <- genind2hierfstat(ind_aztf_pop)
boot.vc(at.pop[1], at.pop[-1])$ci
```
##### Year Grouping
``` {r CI fstat yr, echo=FALSE}
at.yr <- genind2hierfstat(ind_aztf_yr)
boot.vc(at.yr[1], at.yr[-1])$ci
```
#### Pairwise Fst
Method used = Nei's
##### Population Grouping
``` {r pairwise fstat pop, echo=FALSE}
pw.fst.pop <- hierfstat::genet.dist(ind_aztf_pop, method = "Nei87")
pw.fst.pop <- as.data.frame(as.matrix(pw.fst.pop))
pw.fst.pop[upper.tri(pw.fst.pop)] <- NA
kable(round(pw.fst.pop,3))
```
##### Year Grouping
``` {r pairwise fstat yr, echo=FALSE}
pw.fst.yr <- hierfstat::genet.dist(ind_aztf_yr, method = "Nei87")
pw.fst.yr <- as.data.frame(as.matrix(pw.fst.yr))
pw.fst.yr[upper.tri(pw.fst.yr)] <- NA
kable(round(pw.fst.yr,3))
```

*Note: Can only do PCA when matrix is Euclidean!*

### **5. Estimate inbreeding?**
*Is there an excess of homozygosity in a given individual?*
``` {r inbreeding, echo=FALSE}
```

### **6. Multivariate analysis**
#### PCA
*Need to deal with NA values first*  
There are `r sum(is.na(ind_aztf_pop$tab))` missing data to be replaced  
Replace missing data with mean allele frequency
``` {r na replace pop, echo=FALSE, message=FALSE}
library(gtools)
# replace missing values with mean of corresponding allele
X.pop <- gtools::na.replace(ind_aztf_pop$tab, mean, na.rm = TRUE)
X.pop[1:5,1:5]
```
``` {r na replace yr, echo=FALSE, message=FALSE}
library(gtools)
# replace missing values with mean of corresponding allele
X.yr <- gtools::na.replace(ind_aztf_yr$tab, mean, na.rm = TRUE)
X.yr[1:5,1:5]
```
#####Populations
```{r pca set up, echo=FALSE}
pca1 <- dudi.pca(X.pop, scale = FALSE, scannf = FALSE, nf = 3)
barplot(pca1$eig[1:50], main = "PCA eigenvalues", col = heat.colors(50))
```
``` {r basic scatterplot, echo=FALSE}
s.label(pca1$li) #li is the principle components, which in this case is summary of genetic diversity
title("PCA of AZTF Populations - axes 1-2")
add.scatter.eig(pca1$eig[1:20], 3,1,2)
```
``` {r alt. scatter, echo=FALSE}
#s.class(pca1$li, pop(ind_aztf))
#title("PCA of AZTF dataset - axes 1-2")
#add.scatter.eig(pca1$eig[1:20], 3,1,2)

col <- funky(15)
s.class(pca1$li, pop(ind_aztf_pop),xax=1,yax=2, col=transp(col,.8), axesell=FALSE,
cstar=0, cpoint=3, grid=FALSE)
```
``` {r, echo=FALSE}
s.class(pca1$li, pop(ind_aztf_pop),xax=1,yax=3,sub="PCA 1-3",csub=2)
title("PCA of AZTF Populations - axes 1-3")
add.scatter.eig(pca1$eig[1:20],nf=3,xax=1,yax=3)
```
``` {r, echo=FALSE}
colorplot(pca1$li[c(1,3)], pca1$li, transp=TRUE, cex=3, xlab="PC 1", ylab="PC 3")
title("PCA of AZTF Populations - axes 1-3")
abline(v=0,h=0,col="grey", lty=2)
```

#####Years
```{r pca set up yr, echo=FALSE}
pca2 <- dudi.pca(X.yr, scale = FALSE, scannf = FALSE, nf = 3)
barplot(pca2$eig[1:50], main = "PCA eigenvalues", col = heat.colors(50))
```
``` {r basic scatterplot yr, echo=FALSE}
s.label(pca2$li) #li is the principle components, which in this case is summary of genetic diversity
title("PCA of AZTF Years - axes 1-2")
add.scatter.eig(pca2$eig[1:20], 3,1,2)
```
``` {r alt. scatter yr, echo=FALSE}
#s.class(pca2$li, pop(ind_aztf))
#title("PCA of AZTF dataset - axes 1-2")
#add.scatter.eig(pca2$eig[1:20], 3,1,2)

col <- funky(15)
s.class(pca2$li, pop(ind_aztf_yr),xax=1,yax=2, col=transp(col,.8), axesell=FALSE,
cstar=0, cpoint=3, grid=FALSE)
```
``` {r, echo=FALSE}
s.class(pca2$li, pop(ind_aztf_yr),xax=1,yax=3,sub="PCA 1-3",csub=2)
title("PCA of AZTF Years - axes 1-3")
add.scatter.eig(pca2$eig[1:20],nf=3,xax=1,yax=3)
```
``` {r, echo=FALSE}
colorplot(pca2$li[c(1,3)], pca2$li, transp=TRUE, cex=3, xlab="PC 1", ylab="PC 3")
title("PCA of AZTF Years - axes 1-3")
abline(v=0,h=0,col="grey", lty=2)
```